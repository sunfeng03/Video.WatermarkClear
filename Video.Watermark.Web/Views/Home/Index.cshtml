@{
    ViewData["Title"] = "Home Page";
}

<div class="content layui-row">

    <div class="ym-header layui-row layui-col-xs12 layui-col-sm12 layui-col-md12 layui-col-lg12">
        <div class="layui-logo">
        </div>
        <ul class="layui-nav layui-row" lay-filter="mnav">
            <li class="layui-nav-item">
                <a id="to_record" class="is_login" href="#">短视频批量去水印</a>
            </li>
        </ul>
    </div>

    <div class="ym-body  layui-row layui-col-space20 layui-col-xs12 layui-col-sm12 layui-col-md12 layui-col-lg12">
        <div class="relogotool layui-row">
            <div class="layui-card layui-col-xs12 layui-col-sm12 layui-col-md12 layui-col-lg12">
                <div class="layui-card-header">
                    <div class="tool-bar">
                        <span>支持平台(抖音、快手小视频)</span>
                    </div>
                </div>
                <div class="layui-card-body">
                    <div class="layui-form layui-form-pane">
                        <ul class="layui-row img-ul">
                            <li class="layui-nav-item img-li">
                                <a href="##"><img src="~/images/douyin.png" class="img-show" alt="抖音"></a>
                            </li>
                            <li class="layui-nav-item img-li">
                                <a href="##"><img src="~/images/kuaishou.png" class="img-show" alt="快手"></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="layui-card layui-col-xs12 layui-col-sm12 layui-col-md12 layui-col-lg12">
                <div class="layui-card-header">
                    <div class="tool-bar">
                        <span class="layui-badge-dot"></span>
                        <span class="layui-badge-dot layui-bg-orange"></span>
                        <span class="layui-badge-dot layui-bg-green"></span>
                        <span class="layui-badge layui-bg-gray">去水印工具</span>
                        <span class="layui-badge-dot layui-bg-cyan"></span>
                        <span class="layui-badge-dot layui-bg-blue"></span>
                        <span class="layui-badge-dot layui-bg-black"></span>
                    </div>
                </div>
                <div class="layui-card-body">
                    <div class="layui-form layui-form-pane">
                        <div class="layui-form-item">
                            <label class="layui-form-label lable-1">输入链接</label>

                            <div class="layui-input-block">
                                <input id="qsy-url" type="text" class="layui-input" placeholder="输入视频分享链接" title="输入视频分享链接">
                            </div>
                        </div>

                        <!-- 电脑 -->
                        <div class="layui-form-item layui-hide-xs layui-show-sm-inline-block layui-show-md-inline-block layui-show-lg-inline-block">
                            <button type="button" class="layui-btn-sm layui-btn layui-btn-primary reset_btn layui-bg-orange">
                                清空
                            </button>
                            <button type="submit" class="layui-btn-sm layui-btn qsy-submit layui-bg-blue" lay-submit="" lay-filter="msubmit">
                                去除水印
                            </button>
                        </div>

                        <!-- 手机 -->
                        <div class="layui-form-item layui-row layui-col-space10 layui-hide-sm layui-hide-md layui-hide-lg layui-show-xs-block">
                            <div class="layui-btn-group layui-col-xs12 layui-col-sm12 layui-col-md12 layui-col-lg12">
                                <button type="button" class="layui-btn-sm layui-bg-orange layui-btn layui-btn-primary   layui-col-xs4 layui-col-sm4 layui-col-md12 layui-col-lg12 reset_btn">
                                    清空
                                </button>
                                <button type="submit" class="layui-btn-sm layui-bg-blue qsy-submit layui-btn  layui-col-xs8 layui-col-sm8 layui-col-md12 layui-col-lg12" lay-submit="" lay-filter="msubmit">
                                    去除水印
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="layui-card layui-col-xs12 layui-col-sm12 layui-col-md12 layui-col-lg12">
                <div class="layui-card-header">
                    <div class="tool-bar">
                        <span>使用说明</span>
                    </div>
                </div>
                <div class="layui-card-body">
                    <span class="layui-badge layui-bg-gray">功能完善中，如遇点击下载按钮无响应，请按下图方式下载视频</span>
                    <div class="layui-form layui-form-pane">

                        <ul class="layui-row img-ul">
                            <li class="layui-nav-item img-li" style="">
                                <a href="##"><img src="~/images/shuoming.png" class="img-remark" alt="火山小视频"></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="layui-card layui-col-xs12 layui-col-sm12 layui-col-md12 layui-col-lg12">
                <fieldset class="layui-elem-field layui-field-title layui-col-xs12 layui-col-sm12 layui-col-md12 layui-col-lg12">
                    <legend>声明</legend>
                    <div class="layui-field-box">
                        <div class="layui-card-body">
                            <div class="layui-colla-item">
                                <span>欢迎大家交流学习，咨询请添加微信</span>
                                <a href="##"><img src="~/images/weixin.jpg" style="height: 100px;width: 100px"></a>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="layui-col-xs12 layui-col-sm12 layui-col-md12 layui-col-lg12">
                &nbsp;
            </div>
            <div class="layui-col-xs12 layui-col-sm12 layui-col-md3 layui-col-lg3">
                &nbsp;
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script type="text/javascript">

        layui.use(['layer', 'element'], function () {
            var $ = layui.jquery;
        });

        function copy(felu) {
            var Url = document.getElementById(felu);
            Url.select();
            document.execCommand("Copy");
            layer.msg('复制成功');
        }

        function downloadVideo(url, desc) {
            if (isEmpty(url)) {
                layer.msg('视频地址为空');
                return;
            }
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'blob';
            xhr.setRequestHeader("Access-Control-Allow-Origin", "*");
            xhr.setRequestHeader("Access-Control-Allow-Credentials", true);
            xhr.onload = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    let blob = this.response;

                    let u = window.URL.createObjectURL(new Blob([blob]))
                    let a = document.createElement('a');
                    a.download = desc + '.mp4';
                    a.href = u;
                    a.style.display = 'none'
                    document.body.appendChild(a)
                    a.click();
                    a.remove();
                }
            };
            xhr.send()
        }

        $(function () {
            $('.qsy-submit').click(function () {

                $('.qsy-submit').attr('disabled', true);
                var link = rexUrl($('#qsy-url').val());
                if (isEmpty(link)) {
                    layer.msg('请输入视频分享链接');
                    $('.qsy-submit').attr('disabled', false);
                    return false;
                }
                var index = layer.load(0);
                $.ajax({
                    url: '/Home/ParseVideoUrl',
                    type: 'POST',
                    data: { "url": link },
                    success: function (data) {
                        $('.qsy-submit').attr('disabled', false);
                        try {
                            var rows = JSON.parse(data);
                            layer.close(index);
                            layer.open({
                                type: 1,
                                title: false,
                                closeBtn: 1,
                                shadeClose: true,
                                skin: 'yourclass',
                                content: `<div style="overflow:hidden;height: 580px;width: 350px;"><div><div class="popButton"><a href="###" rel="noopener nofollow noreferrer" onclick="downloadVideo('${rows['videoUrl']}','${rows['desc']}')"><button class="layui-bg-red layui-btn-sm layui-btn">下载视频</button></a></div><div class="popButton"><textarea id="videourl" cols="1" rows="1" style="height:0;width:0;position: absolute;">${rows['videoUrl']}</textarea><button class="layui-btn-sm layui-bg-blue layui-btn" onclick="copy('videourl')">复制链接</button></div><div class="popButton"><a href="###" rel="noopener nofollow noreferrer" onclick="downloadVideo('${rows['musicUrl']}','${rows['desc']}')"><button class="layui-btn-sm layui-btn">下载音频</button></a></div><video id="video" width="360px" height="550px" src="${rows['videoUrl']}" controls="true" poster="${rows['videoPic']}" preload="auto" webkit-playsinline="true" playsinline="true" x-webkit-airplay="allow" x5-video-player-type="h5" x5-video-player-fullscreen="true" x5-video-orientation="portraint" style="object-fit:fill"><source src="${rows['videoUrl']}" type="video/mp4"> </video></div></div>`
                            });
                        } catch (error) {
                            layer.alert('解析失败:' + error, {
                                title: '消息',
                                skin: 'layui-layer-lan',
                                closeBtn: 0,
                                anim: 4 
                            });
                            return false;
                        }
                    },
                    error: function (err) {
                        console.log(err);
                        layer.close(index);
                        $('.qsy-submit').attr('disabled', false);
                    },
                    done: function () {
                        layer.close(index);
                    }
                })
            });

            $('.reset_btn').click(function () {
                $('#qsy-url').val("");
            });
            $('.tool-vip-set').click(function () {
                $('.vip').fadeToggle();
            });
        });
    </script>

}